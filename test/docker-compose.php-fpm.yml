version: "3"

services:

  mysql:
    image: docker.io/mysql/mysql-server:8.0
    container_name: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${BATS_MYSQL_ROOT_DB_PASSWORD}
      - MYSQL_USER=${BATS_MYSQL_DB_USER}
      - MYSQL_PASSWORD=${BATS_MYSQL_DB_PASSWORD}
      - MYSQL_DATABASE=${BATS_MYSQL_DB_NAME}
      - DEBUG=false
    networks:
      - default
    mem_limit: 512m
    healthcheck:
      interval: 5s
      timeout: 5s
      retries: 5
      test: mysqladmin ping -h 127.0.0.1 -u $$MYSQL_USER --password=$$MYSQL_PASSWORD

  nginx:
    image: docker.io/nginx:alpine
    container_name: nginx
    ports:
      - 9000:9000
    command: [nginx, '-g', 'daemon off;']
    depends_on:
      - php
    volumes:
      - app_var:/app/var
      - app_src:/usr/share/nginx/html
      - nginx_config:/etc/nginx/conf.d
    networks:
      - default
    mem_limit: 128m

  php:
    image: ${BATS_PHP_DOCKER_IMAGE_NAME}
    container_name: php
    user: "${BATS_UID}"
    environment: 
      - PHP_FPM_MAX_CHILDREN_AUTO_RESIZING=${BATS_PHP_FPM_MAX_CHILDREN_AUTO_RESIZING}
      - PHP_FPM_MAX_CHILDREN=${BATS_PHP_FPM_MAX_CHILDREN}
      - PHP_FPM_REQUEST_MAX_MEMORY_IN_MEGABYTES=${BATS_PHP_FPM_REQUEST_MAX_MEMORY_IN_MEGABYTES}
      - CONTAINER_HEAP_PERCENT=${BATS_CONTAINER_HEAP_PERCENT}
      - DB_DRIVER=${BATS_MYSQL_DB_DRIVER}
      - DB_HOST=${BATS_MYSQL_DB_HOST}
      - DB_PORT=${BATS_MYSQL_DB_PORT}
      - DB_USER=${BATS_MYSQL_DB_USER}
      - DB_PASSWORD=${BATS_MYSQL_DB_PASSWORD}
      - DB_NAME=${BATS_MYSQL_DB_NAME}
      - VARNISH_ENABLED=${BATS_VARNISH_ENABLED}
    command: ["php-fpm","-F","-R"]
    volumes:
      - app_bin:/app/bin/container-entrypoint.d
      - app_var:/app/var
      - app_etc:/app/etc
      - app_src:/usr/share/nginx/html 
    networks:
      - default
    mem_limit: 512m
    read_only: true

volumes:
  app_bin:
    external:
      name: ${BATS_APP_BIN_VOLUME_NAME}
  app_var:
    external:
      name: ${BATS_APP_VAR_VOLUME_NAME}
  app_etc:
    external:
      name: ${BATS_APP_ETC_VOLUME_NAME}
  app_src:
    external:
      name: ${BATS_APP_SRC_VOLUME_NAME}
  nginx_config:
    external:
      name: ${BATS_NGINX_CONFIG_VOLUME_NAME}

networks:
  default:
    external:
      name: docker_default
